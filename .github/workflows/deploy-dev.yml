name: Deploy (dev - full image)

on:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      BACKEND_IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/writing-editor-backend
      FRONTEND_IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/writing-editor-frontend
      IMAGE_TAG: dev-${{ github.sha }}
      IMAGE_LATEST_TAG: dev-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.BACKEND_IMAGE_NAME }}:${{ env.IMAGE_LATEST_TAG }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.FRONTEND_IMAGE_NAME }}:${{ env.IMAGE_LATEST_TAG }}

      - name: Deploy full stack via SSH (pull and run only)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 30m
          script: |
            set -e

            BACKEND_IMAGE="${{ env.BACKEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
            FRONTEND_IMAGE="${{ env.FRONTEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
            ENV_FILE="/cowrite/.env"
            UPLOADS_DIR="/cowrite/uploads"
            NET="cowrite-net"

            if [ ! -f "$ENV_FILE" ]; then
              echo "Missing $ENV_FILE" >&2
              exit 1
            fi

            mkdir -p "$UPLOADS_DIR"
            docker network inspect "$NET" >/dev/null 2>&1 || docker network create "$NET"

            if [ -n "${{ secrets.GHCR_USERNAME }}" ] && [ -n "${{ secrets.GHCR_TOKEN }}" ]; then
              echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin
            else
              echo "GHCR credentials not set. Trying anonymous pull."
            fi

            docker pull "$BACKEND_IMAGE"
            docker pull "$FRONTEND_IMAGE"
            docker pull redis:7-alpine

            docker rm -f cowrite-frontend cowrite-backend cowrite-sync-service cowrite-ai-service cowrite-redis 2>/dev/null || true

            docker run -d               --name cowrite-redis               --restart unless-stopped               --network "$NET"               --network-alias redis               -p 6879:6379               -v redis_data:/data               redis:7-alpine

            docker run -d               --name cowrite-backend               --restart unless-stopped               --network "$NET"               --env-file "$ENV_FILE"               -e SERVICE_NAME=backend               -e AI_SERVICE_URL=http://127.0.0.1:8000               -e CORE_API_INTERNAL_URL=http://127.0.0.1:3000               --add-host host.docker.internal:host-gateway               -p 8100:3000               -p 8102:3001               -p 8101:8000               -v "$UPLOADS_DIR:/app/uploads"               "$BACKEND_IMAGE"

            docker run -d               --name cowrite-frontend               --restart unless-stopped               --network "$NET"               --env-file "$ENV_FILE"               -p 3100:3000               "$FRONTEND_IMAGE"
