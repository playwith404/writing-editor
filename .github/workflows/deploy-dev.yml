name: Deploy (dev - full image)

on:
  workflow_dispatch:
  repository_dispatch:
    types:
      - deploy-dev-full

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      BACKEND_IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/writing-editor-backend
      FRONTEND_IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/writing-editor-frontend
      IMAGE_TAG: dev-${{ github.sha }}
      IMAGE_LATEST_TAG: dev-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.BACKEND_IMAGE_NAME }}:${{ env.IMAGE_LATEST_TAG }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.FRONTEND_IMAGE_NAME }}:${{ env.IMAGE_LATEST_TAG }}

      - name: Upload nginx config
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: deploy/nginx/default.conf
          target: /tmp/gleey-deploy

      - name: Deploy full stack via SSH (pull and run only)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 30m
          script: |
            set -e

            BACKEND_IMAGE="${{ env.BACKEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
            FRONTEND_IMAGE="${{ env.FRONTEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
            ENV_CANDIDATES="/gleey/.env $HOME/gleey/.env /srv/gleey/.env"
            ENV_FILE=""
            NET="gleey-net"

            for CANDIDATE in $ENV_CANDIDATES; do
              if [ -f "$CANDIDATE" ]; then
                ENV_FILE="$CANDIDATE"
                break
              fi
            done

            if [ -z "$ENV_FILE" ]; then
              echo "Missing env file. Checked: $ENV_CANDIDATES" >&2
              echo "whoami=$(whoami) host=$(hostname)" >&2
              ls -ld /gleey "$HOME/gleey" /srv/gleey 2>/dev/null || true
              exit 1
            fi
            APP_ROOT="$(dirname "$ENV_FILE")"
            UPLOADS_DIR="$APP_ROOT/uploads"
            NGINX_DIR="$APP_ROOT/nginx"
            NGINX_CONF="$NGINX_DIR/default.conf"
            SSL_DIR="/etc/nginx/ssl"
            SSL_CERT="$SSL_DIR/origin.crt"
            SSL_KEY="$SSL_DIR/origin.key"
            NGINX_SOURCE_CANDIDATES="/tmp/gleey-deploy/deploy/nginx/default.conf /tmp/deploy/nginx/default.conf /tmp/default.conf"
            NGINX_SOURCE_FILE=""

            for CANDIDATE in $NGINX_SOURCE_CANDIDATES; do
              if [ -f "$CANDIDATE" ]; then
                NGINX_SOURCE_FILE="$CANDIDATE"
                break
              fi
            done

            if [ -z "$NGINX_SOURCE_FILE" ]; then
              echo "Missing nginx config. Checked: $NGINX_SOURCE_CANDIDATES" >&2
              exit 1
            fi

            mkdir -p "$UPLOADS_DIR" "$NGINX_DIR"
            if [ ! -f "$SSL_CERT" ] || [ ! -f "$SSL_KEY" ]; then
              echo "Missing SSL files for nginx strict mode." >&2
              echo "Expected: $SSL_CERT and $SSL_KEY" >&2
              exit 1
            fi
            if [ ! -s "$SSL_CERT" ] || [ ! -s "$SSL_KEY" ]; then
              echo "SSL files are empty." >&2
              echo "Expected non-empty: $SSL_CERT and $SSL_KEY" >&2
              exit 1
            fi
            if ! openssl x509 -in "$SSL_CERT" -noout >/dev/null 2>&1; then
              echo "Invalid SSL certificate PEM: $SSL_CERT" >&2
              exit 1
            fi
            if ! openssl pkey -in "$SSL_KEY" -noout >/dev/null 2>&1; then
              echo "Invalid SSL private key PEM: $SSL_KEY" >&2
              exit 1
            fi
            CERT_PUB_HASH="$(openssl x509 -in "$SSL_CERT" -pubkey -noout 2>/dev/null | openssl pkey -pubin -outform der 2>/dev/null | openssl dgst -sha256 | awk '{print $NF}')"
            KEY_PUB_HASH="$(openssl pkey -in "$SSL_KEY" -pubout -outform der 2>/dev/null | openssl dgst -sha256 | awk '{print $NF}')"
            if [ -z "$CERT_PUB_HASH" ] || [ -z "$KEY_PUB_HASH" ] || [ "$CERT_PUB_HASH" != "$KEY_PUB_HASH" ]; then
              echo "SSL certificate and key do not match." >&2
              exit 1
            fi
            docker network inspect "$NET" >/dev/null 2>&1 || docker network create "$NET"

            if [ -n "${{ secrets.GHCR_USERNAME }}" ] && [ -n "${{ secrets.GHCR_TOKEN }}" ]; then
              echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin
            else
              echo "GHCR credentials not set. Trying anonymous pull."
            fi

            docker pull "$BACKEND_IMAGE"
            docker pull "$FRONTEND_IMAGE"
            docker pull redis:7-alpine

            docker rm -f gleey-nginx gleey-frontend gleey-backend gleey-sync-service gleey-ai-service gleey-redis 2>/dev/null || true

            docker run -d               --name gleey-redis               --restart unless-stopped               --network "$NET"               --network-alias redis               -v redis_data:/data               redis:7-alpine

            docker run -d               --name gleey-backend               --restart unless-stopped               --network "$NET"               --network-alias backend               --env-file "$ENV_FILE"               -e SERVICE_NAME=backend               -e AI_SERVICE_URL=http://127.0.0.1:8000               -e CORE_API_INTERNAL_URL=http://127.0.0.1:3000               --add-host host.docker.internal:host-gateway               -v "$UPLOADS_DIR:/app/uploads"               "$BACKEND_IMAGE"

            docker run -d               --name gleey-frontend               --restart unless-stopped               --network "$NET"               --network-alias frontend               --env-file "$ENV_FILE"               "$FRONTEND_IMAGE"

            cp "$NGINX_SOURCE_FILE" "$NGINX_CONF"

            docker run -d               --name gleey-nginx               --restart unless-stopped               --network "$NET"               -p 80:80               -p 443:443               -v "$NGINX_CONF:/etc/nginx/conf.d/default.conf:ro"               -v "$SSL_DIR:/etc/nginx/ssl:ro"               nginx:1.27-alpine
