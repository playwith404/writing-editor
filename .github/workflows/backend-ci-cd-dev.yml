name: Backend CI/CD (dev)

on:
  push:
    branches:
      - dev
    paths:
      - "backend/**"
      - "database/**"
      - "deploy/**"
      - ".github/workflows/backend-ci-cd-dev.yml"
  workflow_dispatch:

env:
  IMAGE_REPO: ms9019/cowrtie

jobs:
  test-core-sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [core, sync]
    defaults:
      run:
        working-directory: backend/${{ matrix.service }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/${{ matrix.service }}/package-lock.json
      - name: Install
        run: npm ci
      - name: Test
        run: npm test
      - name: Build
        run: npm run build

  test-ai:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend/ai
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/ai/requirements-dev.txt
      - name: Install
        run: pip install -r requirements.txt -r requirements-dev.txt
      - name: Test
        run: pytest

  build-push:
    runs-on: ubuntu-latest
    needs: [test-core-sync, test-ai]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push core-api
        uses: docker/build-push-action@v5
        with:
          context: backend/core
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}:core-dev-${{ github.sha }}
            ${{ env.IMAGE_REPO }}:core-dev-latest

      - name: Build and push sync-service
        uses: docker/build-push-action@v5
        with:
          context: backend/sync
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}:sync-dev-${{ github.sha }}
            ${{ env.IMAGE_REPO }}:sync-dev-latest

      - name: Build and push ai-service
        uses: docker/build-push-action@v5
        with:
          context: backend/ai
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}:ai-dev-${{ github.sha }}
            ${{ env.IMAGE_REPO }}:ai-dev-latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-push
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Copy compose file to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          source: "deploy/docker-compose.dev.yml"
          target: "/srv/cowrite"
      - name: Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            cd /srv/cowrite
            docker compose -f docker-compose.dev.yml up -d redis
            docker compose -f docker-compose.dev.yml pull core-api sync-service ai-service
            docker compose -f docker-compose.dev.yml up -d --no-deps core-api sync-service ai-service
